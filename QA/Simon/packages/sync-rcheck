#!/bin/sh

# rsync package check results with deployment server

: ${BASE=/Volumes/Builds/packages}
: ${server=cran@rcloud.nz}

echo "Finding build name ..."
## find eligible results and deduce <biname> from it
biname=$(ls */results/?.?/00_system_info | head -n1 | sed 's:/.*::')
echo " == $biname =="

if [ -z "${biname}" ]; then
    echo "** ERROR: oscode is empty, check your installation."
    exit 1
fi

OWD=`pwd`
cd "$BASE"

echo " - check sync target"

if ! ssh -o StrictHostKeyChecking=accept-new $server true; then
    echo "ERROR: cannot connect as $server" >&2
    exit 1
fi

versions=`sed -e 's/:.*//' $BASE/vers`
for v in $versions; do
    echo " - syncing $v"
    rsync -avz --delete-after ${biname}/results/$v/ ${server}:/data/results/${biname}/results/$v/
done

cd "$OWD"

